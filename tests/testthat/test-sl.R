library(SuperLearner)

context("Fits and prediction of classic Super Learner with HAL.")

# easily compute MSE
mse <- function(preds, y) {
  mean((preds - y)^2)
}

# simulation constants
set.seed(479512)
p <- 3  # dimensionality
n <- 200  # observations

# simulate data
x <- as.data.frame(replicate(p, rnorm(n)))
y <- sin(1 / x[, 2])  + rnorm(n, 0, 0.1)
test_x <- as.data.frame(replicate(p, rnorm(n)))
test_y <- sin(1 / test_x[, 2]) + cos(test_x[, 3]) + rnorm(n, 0, 0.1)

# run HAL by itself
hal <- fit_hal(X = x, Y = y, yolo = FALSE)
pred_hal_train <- predict(hal, new_data = x)
pred_hal_test <- predict(hal, new_data = test_x)

# run SL-classic with glmnet and get predictions
hal_sl <- SuperLearner(Y = y, X = x, SL.lib = "SL.hal9001")
pred_hal_sl_train <- as.numeric(predict(hal_sl, newX = x)$pred)
pred_hal_sl_test <- as.numeric(predict(hal_sl, newX = test_x)$pred)

# run an SL with HAL and some parametric learners
sl <- SuperLearner(Y = y, X = x, SL.lib = c("SL.mean", "SL.glm", "SL.glmnet",
                                            "SL.hal9001"))
pred_sl_train <- as.numeric(predict(sl, newX = x)$pred)
pred_sl_test <- as.numeric(predict(sl, newX = test_x)$pred)

# test for HAL vs. SL-HAL: outputs are the same length
expect_equal(length(pred_hal_train), length(pred_hal_sl_train))
expect_equal(length(pred_hal_test), length(pred_hal_sl_test))

# test for MSE: HAL < SL-HAL when SL library is only HAL
expect_true(abs(mse(pred_hal_train, y) / mse(pred_hal_sl_train, y) - 1) < 0.50)
expect_true(abs(mse(pred_hal_test, test_y) /
                mse(pred_hal_sl_test, test_y) - 1) < 0.75)

# test of MSEs being close: SL-HAL and SL dominated by HAL should be very close
# (hence the rather low tolerance, esp. given an additive scale)
expect_true(abs(mse(pred_sl_test, test_y) -
                mse(pred_hal_sl_test, test_y)) < 0.05)

# test of SL-HAL risk: HAL has lowest CV-risk in the learner library
expect_equivalent(names(which.min(sl$cvRisk)), "SL.hal9001_All")

